# https://circleci.com/gh/OpenWaterAnalytics/Stormwater-Management-Model/

environment:
  SWMM_HOME: /home/ubuntu/Stormwater-Management-Model/Stormwater-Management-Model/
  BUILD_HOME: build
  TEST_HOME: tests/swmm-nrtestsuite

checkout:
  override:
    # The code to run the regression tests is on a specific branch
    - git clone --depth=50 --branch=feature-nrtest https://github.com/OpenWaterAnalytics/Stormwater-Management-Model.git

dependencies:
  pre:
    # We need cmake 3.x
    - sudo add-apt-repository ppa:george-edison55/cmake-3.x -y
  override:
    - sudo apt update
    - sudo apt install --only-upgrade cmake
    - pip install --upgrade pip
    - pip install wheel
    - cd Stormwater-Management-Model; pip install --src buildprod/packages -r tools/requirements.txt

compile:
  override:
    - cd Stormwater-Management-Model; mkdir $BUILD_HOME; cd $BUILD_HOME; cmake ..; make

test:
  override:
    - cd Stormwater-Management-Model; tools/gen-config.sh $SWMM_HOME/$BUILD_HOME/bin > $TEST_HOME/apps/swmm-$CIRCLE_SHA1.json
